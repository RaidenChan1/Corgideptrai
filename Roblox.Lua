--[[
    â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“
    ğŸš€ PANDA AUTH V2.5 LOADER (UPDATED INPUT)
    â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“
]]

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local StarterGui = game:GetService("StarterGui")

-----------------------------------------------------------
-- ğŸ“ Cáº¤U HÃŒNH (HÃƒY ÄIá»€N CHÃNH XÃC)
-----------------------------------------------------------
local LoaderConfig = {
    ServiceID = "ditroblox", -- TÃªn Service trÃªn Panda
    
    -- âš ï¸ QUAN TRá»ŒNG: Link nÃ y PHáº¢I LÃ€ LINK SCRIPT HACK (Github Raw), KHÃ”NG ÄÆ¯á»¢C LÃ€ LINK PANDA
    TargetScript = "https://pandadevelopment.net/virtual/file/ec4f0e9f24a7e775", 
    
    -- Key láº¥y tá»« Global Variable (getgenv)
    InputKey = getgenv().Key 
}
-----------------------------------------------------------

-- [HTTP REQUEST FIX]
local httpRequest = nil
if syn and syn.request then httpRequest = syn.request
elseif http and http.request then httpRequest = http.request
elseif request then httpRequest = request
elseif http_request then httpRequest = http_request
end

local function log(...)
    print("[PandaAuth]", ...)
end

-- [HWID GENERATOR]
local function getHWID()
    local hwid = nil
    if gethwid then 
        local ok, res = pcall(gethwid)
        if ok and res ~= "" then hwid = res end
    end
    if not hwid then
        local ok, res = pcall(function() return game:GetService("RbxAnalyticsService"):GetClientId() end)
        if ok and res ~= "" then hwid = res end
    end
    return hwid or "unknown_hwid"
end

-- [KEY STORAGE]
local function getSavedKeyPath(sid) return sid .. "_v2_key.txt" end

local function saveKey(sid, key)
    if writefile then writefile(getSavedKeyPath(sid), key) end
end

local function loadSavedKey(sid)
    if not isfile then return nil end
    local path = getSavedKeyPath(sid)
    if isfile(path) then return readfile(path) end
    return nil
end

local function clearSavedKey(sid)
    if delfile and isfile(getSavedKeyPath(sid)) then delfile(getSavedKeyPath(sid)) end
end

-- [VALIDATION - CHá»NG BYPASS]
local function validateKey(key, serviceId)
    if not httpRequest then return false, "No HTTP Request" end
    local hwid = getHWID()
    
    -- Encode URL Ä‘á»ƒ trÃ¡nh lá»—i kÃ½ tá»± Ä‘áº·c biá»‡t
    local safeKey = HttpService:UrlEncode(key)
    local safeHWID = HttpService:UrlEncode(hwid)
    local safeService = HttpService:UrlEncode(serviceId)

    local url = "https://pandadevelopment.net/v2_validation?service="..safeService.."&key="..safeKey.."&hwid="..safeHWID
    
    log("Checking key with Server...")
    local ok, response = pcall(function()
        return httpRequest({
            Url = url, 
            Method = "GET",
            Headers = {["User-Agent"] = "Roblox/Client"} -- ThÃªm Header Ä‘á»ƒ giá»‘ng tháº­t
        })
    end)

    if not ok or not response then return false, "Lá»—i káº¿t ná»‘i máº¡ng" end

    local ok2, data = pcall(function() return HttpService:JSONDecode(response.Body) end)
    if not ok2 then return false, "Lá»—i dá»¯ liá»‡u tá»« Server" end

    -- Kiá»ƒm tra ká»¹ tráº¡ng thÃ¡i tráº£ vá»
    if data.V2_Authentication == "success" then
        return true, data
    else
        return false, data.V2_Authentication -- Tráº£ vá» lÃ½ do lá»—i (Key sai/Háº¿t háº¡n)
    end
end

-- ========================================================
-- ğŸš€ PHáº¦N 2: LOGIC CHáº Y SCRIPT (AUTO RUN)
-- ========================================================

local function RunMainScript()
    print("âœ… Key chuáº©n! Äang táº£i Script...")
    
    -- ÄÃ¡nh dáº¥u biáº¿n toÃ n cá»¥c (Script Hub nÃªn check biáº¿n nÃ y)
    getgenv().PandaAuthPassed = true 
    
    StarterGui:SetCore("SendNotification", {
        Title = "Panda Auth",
        Text = "XÃ¡c thá»±c thÃ nh cÃ´ng!",
        Duration = 5
    })
    
    -- Táº£i Script Hub
    local success, err = pcall(function()
        loadstring(game:HttpGet(LoaderConfig.TargetScript))()
    end)
    
    if not success then
        warn("âŒ Link TargetScript bá»‹ lá»—i: " .. tostring(err))
        StarterGui:SetCore("SendNotification", {Title = "Lá»—i Script", Text = "Link Script Hub bá»‹ há»ng!", Duration = 5})
    end
end

-- [MAIN LOGIC]
print("ğŸ”„ Äang khá»Ÿi Ä‘á»™ng Panda Auth V2.5...")

local keyToValidate = LoaderConfig.InputKey
local isSavedKey = false

-- 1. Náº¿u khÃ´ng nháº­p key má»›i, thá»­ tÃ¬m key cÅ©
if not keyToValidate or keyToValidate == "" then
    local saved = loadSavedKey(LoaderConfig.ServiceID)
    if saved and saved ~= "" then
        print("ğŸ“‚ TÃ¬m tháº¥y key Ä‘Ã£ lÆ°u: " .. saved)
        keyToValidate = saved
        isSavedKey = true
    end
end

-- 2. Báº¯t Ä‘áº§u kiá»ƒm tra
if keyToValidate and keyToValidate ~= "" then
    local isValid, msg = validateKey(keyToValidate, LoaderConfig.ServiceID)
    
    if isValid then
        -- Náº¿u key Ä‘Ãºng -> LÆ°u láº¡i (náº¿u lÃ  key má»›i) vÃ  Cháº¡y Script
        if not isSavedKey then saveKey(LoaderConfig.ServiceID, keyToValidate) end
        RunMainScript()
    else
        -- Náº¿u key sai
        warn("âŒ Key khÃ´ng há»£p lá»‡: " .. tostring(msg))
        
        -- Náº¿u key sai mÃ  lÃ  key cÅ© -> XÃ³a file lÆ°u Ä‘á»ƒ láº§n sau nháº­p láº¡i
        if isSavedKey then 
            print("ğŸ—‘ï¸ Key cÅ© Ä‘Ã£ háº¿t háº¡n, Ä‘ang xÃ³a...")
            clearSavedKey(LoaderConfig.ServiceID)
        end
        
        -- Copy Link Get Key
        local getKeyURL = "https://pandadevelopment.net/getkey?service=" .. LoaderConfig.ServiceID .. "&hwid=" .. getHWID()
        if setclipboard then 
            setclipboard(getKeyURL)
            StarterGui:SetCore("SendNotification", {
                Title = "Key Sai/Háº¿t Háº¡n",
                Text = "ÄÃ£ copy link láº¥y key má»›i!",
                Duration = 10
            })
        end
        
        -- KICK NGÆ¯á»œI CHÆ I (Äá»ƒ cháº¯c cháº¯n khÃ´ng bypass)
        Players.LocalPlayer:Kick("Key sai: " .. tostring(msg))
    end
else
    -- KhÃ´ng cÃ³ key nÃ o Ä‘Æ°á»£c nháº­p
    local getKeyURL = "https://pandadevelopment.net/getkey?service=" .. LoaderConfig.ServiceID .. "&hwid=" .. getHWID()
    if setclipboard then setclipboard(getKeyURL) end
    Players.LocalPlayer:Kick("Vui lÃ²ng nháº­p Key vÃ o Script (getgenv().Key)!")
end
